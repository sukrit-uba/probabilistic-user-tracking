#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Wed Jan 11 12:11:20 2017

@author: uba
"""

import pandas as pd 
from datetime import datetime

data = pd.read_csv('/home/uba/Downloads/logs/wac_1AC1_20160422_0082.log',delimiter=" ",skiprows=1,header=None)
data.columns = ["timestamp","time_taken","c_ip","filesize","s_ip","s_port","sc_status",
                "sc_bytes","cs_method","cs_uri_stem","_","rs_duration","rs_bytes",
                "c_referrer","c_user_agent","customer_id","x_ec_custom_1","None"]
#print(data.columns)
#print(data['c_ip'].value_counts())
#print(len(data['c_ip'].unique()))

ips = pd.Index(data['c_ip'].unique())
s_ips = pd.Index(data['s_ip'].unique())
uris = pd.Index(data['cs_uri_stem'].unique())
user_agents = pd.Index(data['c_user_agent'].unique())
sites = pd.Index(data['x_ec_custom_1'].unique())

print(ips)
#print(ip_id[0])
#print(data[['c_ip','c_user_agent']])
#print(data.groupby(['c_ip','c_user_agent']).size())

def get_index(item, index):
    if pd.isnull(item):
        return -1
        
    try:
        return index.get_loc(item) + 1
    except KeyError:
        return -1
        
#print(get_index('72.66.65.81',ips))

'''make new columns for ml model'''
data["cip_id"] = data["c_ip"].apply(lambda i: get_index(i,ips))
data["sip_id"] = data["s_ip"].apply(lambda i: get_index(i,s_ips))
data["uri_id"] = data["cs_uri_stem"].apply(lambda i: get_index(i,uris))
data["user_agent_id"] = data["c_user_agent"].apply(lambda i: get_index(i,user_agents))
data["site_id"] = data["x_ec_custom_1"].apply(lambda i: get_index(i,sites))

#print(data["cip_id"].unique())
#for each in data[['cip_id','user_agent_id']]:
#    print(each)
'''list of ip and device id pairs'''
s = data[['cip_id','user_agent_id']].values.tolist() 
#print(data[['cip_id','user_agent_id']].unique())
#print(len(s))
data["sum_ip_user_agent_pairs"] = data['cip_id'].map(str)+data['user_agent_id'].map(str)
unique_pairs = pd.Index(data["sum_ip_user_agent_pairs"].unique())
#print(data["sum_ip_user_agent_pairs"].value_counts())
#print(unique_pairs)
#print(unique_pairs)
data["device_id"] = data["sum_ip_user_agent_pairs"].apply(lambda i: get_index(i,unique_pairs))
#print(data["device_id"].value_counts())
#print(data[["cip_id","sip_id","uri_id","user_agent_id","site_id","device_id"==2109]])
#print(data[["cip_id","sip_id","uri_id","user_agent_id","site_id","device_id"]][data["device_id"] == 3939])
#print(data[["cip_id","sip_id","uri_id","user_agent_id","site_id","device_id"]][data["cip_id"] == 3849])

#print(data["device_id"].max())
#print(data["ip_user_agent_pairs"].value_counts())
#print(data.columns)

#print(data['cip_id'].max())
#print(data['user_agent_id'].max())
#print(data['sum_ip_user_agent_pairs'].max())

#print(data.groupby(['cip_id','user_agent_id']).size())
#pairs = pd.DataFrame(data.groupby(['cip_id','user_agent_id']).value_counts())
#print(pairs)
#print(data['_'].value_counts())
'''datetime not so useful as all of them are similar'''
#data["datetime"] = data["timestamp"].apply(lambda t: datetime.fromtimestamp(int(t)))
#print(data["datetime"])

#print(data["cip_id"])

#data.to_csv('data2.csv',columns=["cip_id","sip_id","uri_id","user_agent_id","site_id","device_id"])
'''records = [5120, 5124, 5130, 5132, 5135, 5136, 5142, 5144, 5148, 
           5153, 5156, 5158, 5160, 5170, 5171, 5173, 5175, 5183, 
           5184, 5189, 5191, 5192, 5196, 5198, 5199, 4795, 4796, 
           4800, 4802, 4805, 4806, 4811, 4814, 4819, 4820, 4825, 
           4830, 4835, 4840, 4846, 4852, 4855, 4859, 4863, 4866, 
           4867, 4870, 4871, 4875, 4876, 4879, 4883, 4885, 4888, 
           4889, 4893, 4895, 4896, 4902, 4905, 4910, 4914, 4917, 
           4920, 4921, 4926, 4928, 4933, 4934, 4937, 4940, 4943, 
           4946, 4951, 4955, 4956, 4960, 4961, 4963, 4965, 4968, 
           4970, 4979, 4980, 4987, 4988, 4992, 4993, 4996, 4999, 
           5004, 5007, 5013, 5021, 5024, 5032, 5040, 5044, 5050, 
           5054, 5057, 5062, 5066, 5067, 5072, 5076, 5077, 5081, 
           5083, 5085, 5086, 5089, 5092, 5095, 5096, 5100, 5103, 5111, 5113]'''
'''0.5'''
#records = [6023, 5929, 5995, 6002, 5972, 6010, 5917, 5982, 5951]
#records = [6405, 6661, 6534, 6536, 6668, 6543, 6673, 6546, 6419, 6678, 6551, 6424, 6555, 6815, 6434, 6564, 6441, 6445, 6574, 6321, 6580, 6459, 6588, 6724, 6468, 6597, 6473, 6729, 6607, 6352, 6863, 6612, 6742, 6745, 6489, 6619, 6749, 6368, 6624, 6630, 6502, 6760, 6382, 6640, 6769, 6774, 6519, 6390, 6780, 6525, 6655]
#records = [6437, 6472, 6537, 6377, 6444, 6461, 6322, 6452, 6427, 6397, 6399]
#records = [7138, 7142, 7110, 7144, 7114, 7179, 7116, 7119, 7152, 7157]
#records = [7170, 7175, 7307, 7310, 7183, 7320, 7194, 7324, 7197, 7327, 7331, 7206, 7210, 7340, 7214, 7345, 7219, 7351, 7226, 7227, 7237, 7239, 7112, 7241, 7245, 7118, 7248, 7252, 7127, 7258, 7262, 7269, 7270, 7141, 7275, 7149, 7282, 7156, 7161, 7295]
#records = [8192, 8196, 8197, 8711, 8200, 7689, 8205, 8720, 8218, 7710, 7712, 8738, 8230, 8234, 8750, 8242, 8244, 8246, 8248, 8763, 8770, 8790, 8281, 8794, 8795, 8284, 8799, 8291, 8810, 8302, 8306, 8819, 8309, 8841, 8845, 8847, 8343, 8354, 8359, 7848, 8365, 8368, 8373, 7869, 7875, 7883, 7908, 7913, 7915, 7917, 7919, 8437, 8443, 7941, 7943, 8456, 8464, 8466, 8467, 8469, 7967, 7986, 8528, 8539, 8543, 8562, 8058, 8577, 8071, 8078, 7570, 8082, 8088, 8602, 8094, 8104, 8619, 7598, 8113, 8630, 8132, 8141, 8146, 8664, 8153, 8154, 8177, 8179, 8181, 8185, 8191]
#records = [8965, 8969, 8972, 8977, 8979, 8981, 8999, 8872, 8873, 9001, 9003, 8875, 8877, 8878, 8879, 8896, 8897, 8898, 8911, 8912, 8914, 8923, 8924, 8926, 8929, 8930, 8932, 8942, 8944, 8945, 8950, 8952, 8954]
#records = [8892, 8966, 8887, 8874, 8913, 8882, 8946, 8917, 8982, 8951, 8988, 8991]
#records = [9600, 9410, 9571, 9539, 9346, 9612, 9520, 9331, 9622, 9526, 9593, 9626, 9371, 9502]
#records = [35, 36, 71, 72, 201, 202, 210, 50, 51, 212, 120, 121, 90, 91]
#records = [136, 234, 84, 310, 728, 510, 287]
#records = [2057, 1545, 1035, 1936, 1553, 1937, 1947, 1949, 1443, 1444, 935, 1452, 940, 1457, 1973, 1979, 958, 964, 1486, 1488, 1643, 2420]
#records = [5120, 5124, 5130, 5132, 5135, 5136, 5142, 5144, 5148, 5153, 5156, 5158, 5160, 5170, 5171, 5173, 5175, 5183, 5184, 4165, 5189, 5191, 5192, 5196, 5198, 5199, 4273, 4795, 4796, 4800, 4802, 4805, 4806, 4811, 4814, 4819, 4820, 4825, 4830, 4835, 4840, 4846, 4852, 4855, 4859, 4863, 4866, 4867, 4870, 4871, 4875, 4876, 4879, 4883, 4885, 4888, 4889, 4893, 4895, 4896, 4902, 4905, 4910, 4914, 4917, 4920, 4921, 4926, 4928, 4933, 4934, 4937, 4940, 4943, 4946, 4951, 4955, 4956, 4960, 4961, 4963, 4965, 4968, 4970, 4979, 4980, 4985, 4987, 4988, 4992, 4993, 4996, 4999, 5004, 5007, 5013, 4508, 5021, 5024, 5032, 5040, 5044, 5050, 5054, 5057, 5062, 5066, 5067, 5072, 5076, 5077, 5081, 5083, 5085, 5086, 5089, 5092, 5095, 5096, 5100, 5103, 5111, 5113]

'''0.75'''
#records = [35, 36, 71, 72, 201, 202, 210, 50, 51, 212, 120, 121, 90, 91]
#records = [1030, 1929, 1419, 1813, 1946, 1568, 2336, 1700, 938, 1328, 1332, 1717, 1461, 1850, 1594, 956, 1473, 1602, 1102, 2383, 978, 2388, 1762, 1767, 1640, 1641, 1655, 1534]
#records = [964, 1947, 1452, 940, 1488, 1979]
#records = [2691, 2565, 2694, 3083, 2956, 2955, 2834, 2839, 3249, 3253, 2490, 2492, 3393, 3395, 3014, 3018, 3151, 2640, 2897, 2895, 3155, 2644, 2421, 2427]
#records = [2821, 2662, 2663, 2696, 2472, 3274, 3275, 2444, 3243, 2669, 2798, 2704, 3281, 2480, 2899, 2736, 3250, 2966, 2805, 3227, 2463]
#records = [3211, 3218, 2468, 2473, 2990, 3375, 2935, 2738, 3380, 2612, 2742, 3127, 2871, 2616, 3130, 2875, 2996, 3424, 3425, 2533, 3301, 3303, 2542, 2671, 2675, 3063, 2936, 3066, 2812, 2815]
#records = [4865, 4240, 4120, 4633, 4505, 4379, 4764, 5151, 5283, 5035, 4284, 4927, 4416, 4673, 5317, 4166, 4551, 4807, 5205, 5088, 4455, 5351, 4330, 4076, 4204, 4589, 4975, 4722, 5242]
#records = [5120, 5124, 5130, 5132, 5135, 5136, 5142, 5144, 5148, 5153, 5156, 5158, 5160, 5170, 5171, 5173, 5175, 5183, 5184, 5189, 5191, 5192, 5196, 5198, 5199, 4795, 4796, 4800, 4802, 4805, 4806, 4811, 4814, 4819, 4820, 4825, 4830, 4835, 4840, 4846, 4852, 4855, 4859, 4863, 4866, 4867, 4870, 4871, 4875, 4876, 4879, 4883, 4885, 4888, 4889, 4893, 4895, 4896, 4902, 4905, 4910, 4914, 4917, 4920, 4921, 4926, 4928, 4933, 4934, 4937, 4940, 4943, 4946, 4951, 4955, 4956, 4960, 4961, 4963, 4965, 4968, 4970, 4979, 4980, 4987, 4988, 4992, 4993, 4996, 4999, 5004, 5007, 5013, 5021, 5024, 5032, 5040, 5044, 5050, 5054, 5057, 5062, 5066, 5067, 5072, 5076, 5077, 5081, 5083, 5085, 5086, 5089, 5092, 5095, 5096, 5100, 5103, 5111, 5113]
#records = [5384, 5385, 5909, 5910, 5655, 5783, 5784, 5657, 5675, 5676, 5687, 5688, 5703, 5705, 5835, 5836, 5717, 5718, 5727, 5728, 5736, 5738, 5870, 5871, 5747, 5748, 5755, 5756, 5885, 5886]
#records = [6405, 6661, 6534, 6536, 6668, 6543, 6673, 6546, 6419, 6678, 6551, 6424, 6555, 6815, 6434, 6564, 6441, 6445, 6574, 6321, 6580, 6459, 6588, 6724, 6468, 6597, 6473, 6729, 6607, 6352, 6863, 6612, 6742, 6745, 6489, 6619, 6749, 6368, 6624, 6630, 6502, 6760, 6382, 6640, 6769, 6774, 6519, 6390, 6780, 6525, 6655]
#records = [6437, 6472, 6537, 6377, 6444, 6461, 6322, 6452, 6427, 6397, 6399]
#records = [7170, 7175, 7307, 7310, 7183, 7320, 7194, 7324, 7197, 7327, 7331, 7206, 7210, 7340, 7214, 7345, 7219, 7351, 7226, 7227, 7237, 7239, 7112, 7241, 7245, 7118, 7248, 7252, 7127, 7258, 7262, 7269, 7270, 7141, 7275, 7149, 7282, 7156, 7161, 7295]
#records = [8192, 7941, 8711, 8456, 8841, 8071, 7943, 8845, 8078, 8205, 8464, 8720, 8466, 8467, 8082, 8343, 8602, 7967, 7712, 8738, 8230, 8359, 8104, 7848, 8234, 8365, 8750, 8113, 7986, 8244, 8373, 8630, 8248, 7875, 7883, 8141, 8664, 8153, 8794, 8281, 8154, 8539, 8291, 7913, 7915, 8302, 8562, 8306, 8179, 8309, 8058]

'''0.875'''
#records = [35, 36, 71, 72, 201, 202, 50, 210, 212, 51, 120, 121, 90, 91]
records = [642, 741, 389, 692, 536, 890]
#records = [1030, 1929, 1419, 1813, 1946, 1568, 2336, 1700, 938, 1328, 1332, 1717, 1461, 1850, 1594, 956, 1473, 1602, 1102, 2383, 978, 2388, 1762, 1767, 1640, 1641, 1655, 1534]
#records = [2328, 2337, 2372, 2342, 2375, 1896, 2347, 1134, 2350, 2161, 1842, 1394, 2356, 1878, 1335, 1560, 2362, 2367]
#records = [3393, 2691, 2565, 3014, 3083, 2955, 2895, 2640, 3249, 2834, 3151, 2421, 2490]
#records = [4865, 4240, 4120, 4633, 4505, 4379, 4764, 5151, 5283, 5035, 4284, 4927, 4416, 4673, 5317, 4166, 4551, 4807, 5205, 5088, 4455, 5351, 4330, 4076, 4204, 4589, 4975, 4722, 5242]
#records = [5120, 5124, 5130, 5132, 5135, 5136, 5142, 5144, 5148, 5153, 5156, 5158, 5160, 5170, 5171, 5173, 5175, 5183, 5184, 5189, 5191, 5192, 5196, 5198, 5199, 4795, 4796, 4800, 4802, 4805, 4806, 4811, 4814, 4819, 4820, 4825, 4830, 4835, 4840, 4846, 4852, 4855, 4859, 4863, 4866, 4867, 4870, 4871, 4875, 4876, 4879, 4883, 4885, 4888, 4889, 4893, 4895, 4896, 4902, 4905, 4910, 4914, 4917, 4920, 4921, 4926, 4928, 4933, 4934, 4937, 4940, 4943, 4946, 4951, 4955, 4956, 4960, 4961, 4963, 4965, 4968, 4970, 4979, 4980, 4987, 4988, 4992, 4993, 4996, 4999, 5004, 5007, 5013, 5021, 5024, 5032, 5040, 5044, 5050, 5054, 5057, 5062, 5066, 5067, 5072, 5076, 5077, 5081, 5083, 5085, 5086, 5089, 5092, 5095, 5096, 5100, 5103, 5111, 5113]
#records = [5384, 5385, 5909, 5910, 5655, 5783, 5784, 5657, 5675, 5676, 5687, 5688, 5703, 5705, 5835, 5836, 5717, 5718, 5727, 5728, 5736, 5738, 5870, 5871, 5747, 5748, 5755, 5756, 5885, 5886]
#records = [6405, 6661, 6534, 6536, 6668, 6543, 6673, 6546, 6419, 6678, 6551, 6424, 6555, 6815, 6434, 6564, 6441, 6445, 6574, 6321, 6580, 6459, 6588, 6724, 6468, 6597, 6473, 6729, 6607, 6352, 6863, 6612, 6742, 6745, 6489, 6619, 6749, 6368, 6624, 6630, 6502, 6760, 6382, 6640, 6769, 6774, 6519, 6390, 6780, 6525, 6655]
#records = [6437, 6472, 6537, 6377, 6444, 6461, 6322, 6452, 6427, 6397, 6399]
#records = [6659, 6693, 6637, 7021, 6675, 6708, 6591]
#records = [7170, 7175, 7307, 7310, 7183, 7320, 7194, 7324, 7197, 7327, 7331, 7206, 7210, 7340, 7214, 7345, 7219, 7351, 7226, 7227, 7237, 7239, 7112, 7241, 7245, 7118, 7248, 7252, 7127, 7258, 7262, 7269, 7270, 7141, 7275, 7149, 7282, 7156, 7161, 7295]
#records = [8577, 8196, 8197, 8200, 7689, 8847, 7570, 8469, 8088, 8218, 7710, 8094, 8354, 8619, 7598, 8368, 8242, 8246, 8763, 7869, 8770, 8132, 8528, 8146, 8790, 8795, 8284, 8543, 8799, 7908, 8810, 7917, 7919, 8177, 8819, 8437, 8181, 8185, 8443, 8191]
#records = [8192, 7941, 8711, 8456, 8841, 8071, 7943, 8845, 8078, 8205, 8464, 8720, 8466, 8467, 8082, 8343, 8602, 7967, 7712, 8738, 8230, 8359, 8104, 7848, 8234, 8365, 8750, 8113, 7986, 8244, 8373, 8630, 8248, 7875, 7883, 8141, 8664, 8153, 8794, 8281, 8154, 8539, 8291, 7913, 7915, 8302, 8562, 8306, 8179, 8309, 8058]

#for r in records:
    #print(data[['c_ip','s_ip','cs_uri_stem','c_user_agent','x_ec_custom_1']].loc[r])
    #print(data[['c_ip','x_ec_custom_1']].loc[r].values)